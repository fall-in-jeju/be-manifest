apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-deployment
  labels:
    app: backend-app
spec:
  replicas: 1 # Default value
  selector:
    matchLabels:
      app: backend-app
  template:
    metadata:
      labels:
        app: backend-app
    spec:
      containers:
      - name: backend-app-container
        image: 310688446727.dkr.ecr.ap-northeast-2.amazonaws.com/backend-app:d4e1e87
        ports:
        - containerPort: 8001
        resources:
          requests:
            cpu: "250m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
        
        # Secret을 통째로 환경변수로 로드 (envFrom)
        envFrom:

        env:
        - name: aws.region
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: aws.region
        - name: aws.dynamodb.table-name
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: aws.dynamodb.table-name
        - name: aws.dynamodb.credentials.access-key
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: aws.dynamodb.credentials.access-key
        - name: aws.dynamodb.credentials.secret-key
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: aws.dynamodb.credentials.secret-key
        - name: aws.bedrock.api-gateway-url
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: aws.bedrock.api-gateway-url
        - name: TMAP_APP_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: TMAP_APP_KEY
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: SPRING_DATASOURCE_URL
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: SPRING_DATASOURCE_USERNAME
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: SPRING_DATASOURCE_PASSWORD
        # SPRING_PROFILES_ACTIVE는 overlay에서 정의됨 (dev/prod)
        - name: SERVER_PORT
          value: "8001"
        
        # Cognito 설정 (공개 정보)
        - name: COGNITO_USER_POOL_ID
          value: "ap-northeast-2_c52hfkOYE"
        - name: COGNITO_ISSUER
          value: "https://cognito-idp.ap-northeast-2.amazonaws.com/ap-northeast-2_c52hfkOYE"
        - name: COGNITO_JWKS_URL
          value: "https://cognito-idp.ap-northeast-2.amazonaws.com/ap-northeast-2_c52hfkOYE/.well-known/jwks.json"
        - name: COGNITO_DOMAIN
          value: "https://ap-northeast-2c52hfkoye.auth.ap-northeast-2.amazoncognito.com"
        
        # Cognito 민감 정보 (Secret에서 가져옴)
        - name: COGNITO_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: cognito-secret
              key: COGNITO_CLIENT_ID
        - name: COGNITO_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: cognito-secret
              key: COGNITO_CLIENT_SECRET
        - name: COGNITO_REDIRECT_URI
          valueFrom:
            secretKeyRef:
              name: cognito-secret
              key: COGNITO_REDIRECT_URI
        
        # JWT Secret (민감 정보는 Secret에서 가져옴)
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: JWT_SECRET
        
        # Origin Verification Secret (ALB -> Spring 통신용)
        - name: ORIGIN_VERIFY_SECRET
          valueFrom:
            secretKeyRef:
              name: origin-verify-secret
              key: ORIGIN_VERIFY_SECRET
